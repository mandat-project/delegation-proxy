@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix wild: <http://purl.org/wild/vocab#> .
@prefix frog: <https://solid.ti.rw.fau.de/public/ns/frog#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix org: <http://www.w3.org/ns/org#> .

# Rule for default open status when no signature is present
{
  ?activityInstance a wild:ActivityInstance ;
                    wild:activityInstanceOf ?someAtomicActivity ;
                    frog:signature frog:noSignature .
}
=>
{
  ?activityInstance frog:approval frog:open .
} .

# Rule for atomic activity instance approval (approved if signature is true)
{
  ?activityInstance a wild:ActivityInstance ;
                    wild:activityInstanceOf ?someAtomicActivity ;
                    frog:signature ?signature .
  ?signature a frog:Signature ;
             frog:approval true .
}
=>
{
  ?activityInstance frog:approval frog:approved .
} .

# Rule for atomic activity instance approval (not approved if signature is false)
{
  ?activityInstance a wild:ActivityInstance ;
                    wild:activityInstanceOf ?someAtomicActivity ;
                    frog:signature ?signature .
  ?signature a frog:Signature ;
             frog:approval false .
}
=>
{
  ?activityInstance frog:approval frog:notApproved .
} .

# Collect approvals of child activities for sequential activities
{
  ?seqActivityInstance a wild:ActivityInstance ;
                       wild:activityInstanceOf ?seqActivityType ;
                       wild:hasChildActivities ?childList .
}
=>
{
  ?seqActivityInstance frog:collectApprovals ?childList .
} .

# Base case: An empty list (rdf:nil) means the activity is approved
{
  ?seqActivityInstance a wild:ActivityInstance ;
                       wild:activityInstanceOf ?seqActivityType ;
                       frog:collectApprovals rdf:nil .
}
=>
{
  ?seqActivityInstance frog:approval frog:approved .
} .

# If the first child is not approved, the sequential activity is not approved
{
  ?seqActivityInstance frog:collectApprovals ?childList .
  ?childList rdf:first ?child ;
             rdf:rest ?rest .
  ?child frog:approval frog:notApproved .
}
=>
{
  ?seqActivityInstance frog:approval frog:notApproved .
} .

# If the first child is open, the sequential activity is open
{
  ?seqActivityInstance frog:collectApprovals ?childList .
  ?childList rdf:first ?child ;
             rdf:rest ?rest .
  ?child frog:approval frog:open .
}
=>
{
  ?seqActivityInstance frog:approval frog:open .
} .

# If the first child is approved, continue checking the rest
{
  ?seqActivityInstance frog:collectApprovals ?childList .
  ?childList rdf:first ?child ;
             rdf:rest ?rest .
  ?child frog:approval frog:approved .
}
=>
{
  ?seqActivityInstance frog:collectApprovals ?rest .
} .


# Recursive determination of the rest of the list approval status
{
  ?seqActivityInstance frog:collectApprovals ?rest .
  ?rest frog:approval ?restApproval .
}
=>
{
  ?seqActivityInstance frog:approval ?restApproval .
} .


# Workflow-level rules
{
  ?workflowInstance a wild:WorkflowInstance ;
                    wild:workflowInstanceOf ?workflowModel .
  ?workflowModel wild:hasBehaviour ?act .
  ( ?activityInstance {
      ?activityInstance wild:activityInstanceOf ?someAtomicActivity ;
                        wild:inWorkflowInstance ?workflowInstance .
    } ?activityInstances )
    log:collectAllIn ?workflowModelGraph .
}
=>
{
  ?workflowInstance frog:collectActivityInstances ?activityInstances.
} .

# Base case: An empty list (rdf:nil) means the activity is approved
{
  ?workflowInstance a wild:WorkflowInstance ;
                       frog:collectActivityInstances rdf:nil .
}
=>
{
  ?workflowInstance frog:approval frog:approved .
} .

# Workflow is not approved if any activity is not approved
{
  ?workflowInstance frog:collectActivityInstances ?activityList .
  ?activityList rdf:first ?activityInstance ;
                rdf:rest ?restList .
  ?activityInstance frog:approval frog:notApproved .
}
=>
{
  ?workflowInstance frog:approval frog:notApproved .
} .

# Workflow is open if any activity is open
{
  ?workflowInstance frog:collectActivityInstances ?activityList .
  ?activityList rdf:first ?activityInstance ;
                rdf:rest ?restList .
  ?activityInstance frog:approval frog:open .
}
=>
{
  ?workflowInstance frog:approval frog:open .
} .

# Continue checking the rest of the list
{
  ?workflowInstance frog:collectActivityInstances ?activityList .
  ?activityList rdf:first ?activityInstance ;
                rdf:rest ?restList .
  ?activityInstance frog:approval frog:approved .
}
=>
{
  ?workflowInstance frog:collectActivityInstances ?restList .
} .

# Continue checking the rest of the list
{
  ?workflowInstance frog:collectActivityInstances ?activityList .
  ?activityList rdf:first ?activityInstance ;
                rdf:rest ?restList .
  ?activityInstance frog:approval frog:approved .
}
=>
{
  ?workflowInstance frog:collectActivityInstances ?restList .
} .
